{% extends "base.html" %}
{% load pages_tags mezzanine_tags i18n %}
{% load mezzanine_tags pagination_tags hand_filters html_escape %}

{% block meta_title %}
    Graphs
    {% if query_summary %}({{ query_summary|truncatechars:50 }}){% endif %}
{% endblock %}

{% block main %}
    {% chrono "start template:" %}

    <h1 class='header1'>Search for Graphs</h1>

    {% chrono "form:" %}

    {% comment %}TODO: this empty form should be removed, find out why it is needed. {% endcomment %}
    <form></form>

    <form  id='searchform' class='form-inline panel'  method="GET" action=".">
        <p>
            Filter by
        </p>
        <ul id="drilldownformID" class="flat-list use-chosen">
            {{ drilldownform.as_ul }}
        </ul>
        <p>
            <input type="hidden" value="1" name="submitted" />
            <input type='hidden' name="view" value='{{ view }}' />
            <input type="submit" value="Show Graphs" class='btn btn-primary' />
            <input type='reset' class='btn btn-default' id="reset"/>
            {# This hidden field preserves the last search terms #}
            <input type="hidden" value="{{ request.GET.terms }}" name="terms" />
        </p>
    </form>

    {% chrono ":form" %}

    {% chrono ":breadcrumb" %}

    {% if submitted %}

        {% if query_summary %}
            <p class='breadcrumb' id="search-breadcrumb">
                <span id="auto-scroll"></span>
                You are searching for:
                {{ query_summary|truncatechars:200 }}
            </p>
        {% endif %}

        {% chrono "submitted:" %}

        {% if not hand_ids %}
            <div class='alert alert-warning'>
                <h6>No result found</h6>
            </div>
        {% else %}

            {% chrono "pagination and loading:" %}

            <p>
                {{ graphs_count }} Graphs grouped into {{ hand_ids|length }} Hands.
                {% autopaginate hand_ids 12 %}
                {% chrono "load graphs:" %}
                {% load_hands 'hand_ids' as hands %}
                {% chrono ":load_graphs" %}
            </p>

            <div class="row">

                <div class="col-md-8">
                    {% paginate %}
                </div>

                <div class='col-md-2 pull-right' id="view-switch">

                    <ul class="nav nav-pills">
                        <li class="{% if view == 'images' %}active{% endif %}">
                            <a data-target="#images" data-toggle="pill" title='Change Graph View to Images' href="{% filter add_query_params:request.META.QUERY_STRING %}?view=images{% endfilter %}">Images</a>
                        </li>

                        <li class="{% if view == 'list' %}active{% endif %}">
                            <a data-target="#list" data-toggle="pill" title='Change Graph View to List' href="{% filter add_query_params:request.META.QUERY_STRING %}?view=list{% endfilter %}">List</a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class='tabbable'>
                <div class="tab-content">

                    {% chrono "grid tab:" %}

                    <div class="tab-pane fade {% if view == 'images' %}active in{% endif %}" id="images">

                        {% for hand in hands %}

                            {% if forloop.counter0|divisibleby:4 %}
                                <div class='row'>
                            {% endif %}
                                    <div class='col-md-3 centered col-xs-12'>

                                        <dl class="imageDatabase panel">
                                            <dt>
                                                {% for graph in hand.graphs_template %}
                                                    {% if forloop.counter < 10 %}
                                                        <a data-image-id='{{ graph.annotation.image.id }}' data-placement='bottom' data-type='annotation' data-graph="{{ graph.id }}" data-id='{[ graph.id }}' data-allograph='{{graph.idiograph.allograph.id}}'class='droppable_image graph_img' data-container='body' data-toggle="tooltip" title="{{ graph.display_label }}" href="/digipal/page/{{ graph.annotation.image_id }}/?graph={{ graph.annotation.graph.id }}">
                                                            {% annotation_img graph.annotation lazy=1 %}
                                                        </a>
                                                    {% endif %}
                                                {% endfor %}
                                            </dt>
                                            <dd>
                                                <a href="{{ hand.get_absolute_url }}">
                                                    <strong>{{ hand }}</strong>
                                                </a>
                                            </dd>
                                        </dl>
                                    </div>
                            {% if forloop.counter|divisibleby:4 or forloop.last %}
                                </div>
                            {% endif %}

                        {% endfor %}

                    </div>

                    {% chrono "table tab:" %}

                    <div class="tab-pane fade {% if view == 'list' %}active in{% endif %}" id="list">

                        <table class="table table-condensed">
                            <tr>
                                <th>Graphs</th>
                                <th>Hand</th>
                                <th>Scribe</th>
                                <th>Place</th>
                                <th>Date</th>
                                <th>Repository</th>
                                <th>Shelfmark</th>
                                <th>Catalogue Number</th>
                            </tr>
                            {% for hand in hands %}
                                <tr class="{% cycle 'bgColour' '' %}">
                                    <td>
                                        {% for graph in hand.graphs_template %}
                                            <a data-image-id='{{ graph.annotation.image.id }}' data-placement='bottom' data-container='body' data-type='annotation' data-graph="{{ graph.id }}" data-id='{[ graph.id }}' data-allograph='{{graph.idiograph.allograph.id}}'  class='droppable_image graph_img' data-toggle="tooltip" title="{{ graph.display_label }}" href="/digipal/page/{{ graph.annotation.image.id }}/?graph={{ graph.annotation.graph.id }}">
                                                {% annotation_img graph.annotation lazy=1 %}
                                            </a>
                                        {% endfor %}
                                    </td>
                                    <td>{{ hand }}</td>
                                    <td>{{ hand.scribe }}</td>
                                    <td>{{ hand.assigned_place }}</td>
                                    <td>{{ hand.assigned_date }}</td>
                                    <td>{{ hand.item_part.current_item.repository.name }}</td>
                                    <td>{{ hand.item_part.current_item.shelfmark }}</td>
                                    <td>{{ hand.item_part.historical_item.catalogue_number }}</td>
                                </tr>
                            {% endfor %}
                        </table>

                    </div>

                </div>

                {% chrono ":table tab" %}

                {% paginate %}

            </div>
        {% endif %}

    {% endif %}

    {% include "digipal/add_to_collection.html" %}

    {% chrono ":end template" %}

{% endblock %}

{% block extra_js %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/chosen.jquery.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/query_sorter.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/forms.reset.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}/digipal/scripts/drag_to_lightbox.js"></script>
{% endblock %}

