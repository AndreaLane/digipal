{% load html_escape %}

<span id="info-div" style="position: fixed; z-index: 5000; top:0; left: 0; margin: 0.3em; padding: 0.2em; border: 1px solid orange; background-color: white; diplay: none;"></span>

<div>
    {% comment %}
        server side computes all the drawing data and coordinates
        [
            [[x0, x1], [y0, y1] ]
        ]
        {% for record in result %}
            {{ record.id }}{% if record.found %}*{% endif %}&nbsp;
        {% endfor %}
    {% endcomment %}
    {# Add selectors for X and Y #}
    <div style="min-height:2.5em;">
        &nbsp;

        <div class="btn-group pull-right">
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    {{ vcat.label }}
                   <span class="caret"></span>
                </button>
                <input type="hidden" name="vcat" value="{{ vcat.key }}"/>
                <ul class="dropdown-menu" role="menu">
                    {% for cat in vcats %}
                        <li><a href="{% filter add_query_params:request.META.QUERY_STRING %}?vcat={{ cat.key }}{% endfilter %}">{{ cat.label }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div id="vis-div" style="height:400px; width: 100%; border: 1px solid grey; margin-bottom: 3em;">
    </div>
    <!-- <canvas id="overview-layer1" tabindex="0" class="canvas" id="hands-ol-canvas"
        {# height="{{ canvas.height }}" width="{{ canvas.width }}" #}
        style="height:{{ canvas.height }}px; z-index: 100; width: 100%; border: 1px solid grey;">
    </canvas> -->
</div>

<script type="text/javascript">
//function() {
    var data = {{ canvas|json }};
    var pts = data.drawing.points;
    var xs = data.drawing.x;
    var ys = data.drawing.y;
    var cdims = [data.width, data.height];

function view_init() {
    $(function() {
        $(window).resize(redraw_vis);
    })
    redraw_vis();
}

if (typeof $ !== 'undefined') {
    redraw_vis();
}

function redraw_vis() {
    $('select[name=vcat]').on('change', function() {
        $(this).closest('form').submit();
    });

    var last_selected_point = null;
    var label_margin = 2;
    var font_size = 12;
    var extra_y = font_size+(label_margin*2);
    var extra_x = 200;
    var colors = {'label': '#000080'}
    var point_index = {};
    var point_height = 4;

    var $container = $('#vis-div');
    resize_container($container);
    function resize_container($container) {
        var ret = 200;
        // enough height to write all the category labels
        ret = (font_size + (label_margin * 2)) * (1 + ys.length);
        // enough height to display all the data points with 2px height
        ret_alt = cdims[1] * point_height;
        if (ret_alt > ret) { ret = ret_alt; };
        //
        ret += extra_y;
        $container.css('height', ret + 'px');
        return ret;
    }

    var dims = [$container.width(), $container.height()];
    var $canvas = $('<canvas id="overview-layer1" tabindex="0" class="canvas" height="'+ dims[1] +'" width="' + dims[0] + '" ' +
                    ' style="height2:{{ canvas.height }}px; z-index: 100; width: 100%; border: 0px solid red;">' +
                    '</canvas>'
                );
    $container.html($canvas);
    var ctx = $canvas[0].getContext('2d');

    var ky = 1.0 / (cdims[1] + 1) * (dims[1] - extra_y);
    var ky_min = (ky < 1) ? 1 : Math.floor(ky);
    var kx = 1.0 / (cdims[0] + 1) * (dims[0] - extra_x);
    var kx_min = (kx < 1) ? 1 : Math.floor(kx);
    // x coord of the maximum data point
    var max_x = coord(cdims[0], 0)[0];
    //var dot_size = kx_min < ky_min ? kx_min : ky_min;

    function draw_pt(pt, highlight, add_to_index) {
        ctx.fillStyle = pt[2] ? '#ff0000' : '#808080';
        if (highlight) ctx.fillStyle = '#ffff00';
        var cs = coord(pt[0][0], pt[1]);
        var cs2 = coord(pt[0][1], pt[1]);
        var l = (cs2[0] - cs[0]) + kx_min
        if (cs[0] + l > max_x) {
            l = max_x - cs[0];
        };

        if (add_to_index) {
            if (!point_index[cs[1]]) point_index[cs[1]] = [];
            point_index[cs[1]].push([pt, [cs[0], cs[0]+l]]);
        }

        //ctx.fillRect(cs[0], cs[1], dot_size, dot_size);
        ctx.fillRect(cs[0], cs[1], l, ky_min);
    }

    function draw_xs(axis) {
        // axis
        ctx.fillStyle = colors.label;
        cs = coord(cdims[0], axis[0][1]);
        ctx.fillRect(0, dims[1] - extra_y, cs[0], 1);

        axis.map(function(pt, pti) {draw_label_x(pt); });
        //draw_label(axis[0]);
    }

    function draw_ys(axis) {
        // axis
        ctx.fillStyle = colors.label;
        ctx.fillRect(max_x, 0, 1, dims[1]);

        var max_count = axis.reduce(function(last, cat, i, array) {
            return last + cat[3];
        }, 0);

        axis.map(function(pt, pti) {
            draw_label_y(pt, max_count);
        });
        //draw_label(axis[0]);
    }

    function draw_label_x(pt) {
        // small bar to indicate the pos of the label on the axis
        // TODO: bar size depends on label size
        ctx.fillStyle = colors.label;
        var cs = coord(pt[0], pt[1]);
        ctx.fillRect(cs[0], dims[1] - extra_y, 1, 10);

        // label
        // TODO: label pos depends on label size
        write_text(pt[2], cs[0], dims[1] - extra_y);
    }

    function draw_label_y(pt, max_count) {
        var cs = coord(cdims[0], pt[1]);

        // global % bar
        ctx.fillStyle = '#E0E0E0';
        var pc = (1.0 / max_count) * pt[3];
        ctx.fillRect(dims[0] - Math.ceil(extra_x * pc), cs[1], extra_x, font_size + label_margin * 2);

        // local % bar
        ctx.fillStyle = '#FFB0B0';
        pc = (1.0 / max_count) * pt[4];
        ctx.fillRect(dims[0] - Math.ceil(extra_x * pc), cs[1], extra_x, font_size + label_margin * 2);

        // small bar to indicate the pos of the label on the axis
        // TODO: bar size depends on label size
        if (cs[1] > 1) {
            ctx.fillStyle = '#707070';
            ctx.fillRect(0, cs[1], dims[0], 1);
            ctx.fillStyle = colors.label;
            ctx.fillRect(cs[0], cs[1], extra_x, 1);
        }

        // label
        // TODO: label pos depends on label size
        var label = pt[2] + ' ( ' + pt[4] + ' / ' + pt[3] + ' )';
        write_text(label, cs[0], cs[1], pt[4] ? colors.label : '#404040');
    }

    function write_text(text, x, y, color) {
        ctx.fillStyle = color ? color : colors.label;
        ctx.font = font_size + 'px Arial';
        ctx.fillText(text, x+label_margin, y+font_size + label_margin);
    }

    function coord(x, y) {
        return [Math.floor(x * kx), Math.floor(y * ky)];
    }

    draw_xs(xs);
    draw_ys(ys);
    pts.map(function(pt, pti) {draw_pt(pt, false, true); });

    $canvas.on('mousemove', function(e) {
        // mouse is over canvas
        // we have a selected hand and a selected page
        var pos = get_mouse_pos(this, e);
        show_info_at(pos);
    });

    function get_mouse_pos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
            x: Math.round(1.0 * (evt.clientX - rect.left) / $(canvas).width() * $(canvas).attr('width')),
            y: Math.round(1.0 * (evt.clientY - rect.top) / $(canvas).height() * $(canvas).attr('height')),
        };
    }

    function get_point_from_pos(pos) {
        var ret = null;
        for (var i = 0; i < ky; i++) {
            var pts = point_index[pos.y + i];
            if (pts) {
                pts.map(function(pt, pti) {
                    if (pos.x >= pt[1][0] & pos.x <= pt[1][1]) {
                        ret = pt[0];
                    }
                });
                if (ret) break;
            }
        }
        return ret;
    }

    function show_info_at(pos) {
        var message = '';

        console.log(pos);
        if (last_selected_point) {
            draw_pt(last_selected_point);
        }

        last_selected_point = get_point_from_pos(pos);
        if (last_selected_point) {
            draw_pt(last_selected_point, true);
            message = last_selected_point[3];
        }

        var $info_div = $('#info-div');
        $info_div.toggle(!!message);
        $info_div.html('<table class="table">'+message+'</table>');
    }

}


//}();
</script>
