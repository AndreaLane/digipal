{% extends "base.html" %}
{% load pages_tags mezzanine_tags i18n %}
{% load mezzanine_tags pagination_tags html_escape hand_filters %}

{% block meta_title %}
    Search
    {% if terms %}({{ terms }}){% endif %}
{% endblock %}

{% block main %}

    {% if not submitted %}
        <div class="row">
            <h1 class='header1'>Search</h1>
            <h3>Please type in keyword to search for {{ search_types_display }} and
             use filters to narrow down your search results</h3>
        </div>
    {% endif %}
    <form id='searchform' class="form-inline panel" method="GET" action="/digipal/search">
        <div class='row'>
            {# {% csrf_token %} #}
            <div class='col-lg-9 col-md-9'>
                <div id='radio'>
                    <ul>{{ advanced_search_form.as_ul }}</ul>
                </div>
            </div>
        </div>

        <div class='container'>
            <a id='advanced' class='btn btn-link'>Advanced Search</a>
            <div id='advancedSearch'>
                <div id='labelFilters'></div>
                <div id='containerFilters' class='form-inline'></div>
            </div>
        </div>

        <div class='container' id='buttonsBox'>
            <input type="submit" value="Search" class='btn btn-primary' />
            <a class='btn btn-success' id='show_filters'>Show Graphs Filters</a>
        </div>
    </form>

    <div class="panel" id='filtersform'>
        <h5 class='header5'>Show Graphs filtered by:</h5>
        <form class="container form-inline"  method="GET" action="/digipal/search/graph">
            <ul>{{ drilldownform.as_ul }}</ul>

            <div class='container'>
                <input type="submit" value="Show Graphs" class='btn btn-primary' />
                <input type='reset' class='btn btn-default' />
            </div>
        </form>
    </div>

    {% if submitted %}
        {% if terms %}
            <div class='breadcrumb'>
                <span>You are searching for: </span><span><b>Term</b>: {{terms}}</span>
            </div>
        {% endif %}

        {% if not is_empty %}
            <div class='container'>
                <ul class="nav nav-tabs" id='result-types-switch'>
                    {% for type in types %}
                        <li class="{% if result_type == type.key %}active{% else %}{% if not type.count %}disabled{% endif %}{% endif %}">
                            <a href='{% filter add_query_params:request.META.QUERY_STRING %}?result_type={{ type.key }}{% endfilter %}' data-toggle="tab" data-target="#{{ type.key }}">
                                {{ type.label }} ({{type.count|default:'0'}})
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <div class='tabbable'>
                <div id='result-tab-content' class='tab-content'>
                    {% for type in types %}
                        <div class='tab-pane fade {% if result_type == type.key %}active in{% endif %}' id='{{type.key}}'>
                            {% if type.is_empty %}
                                <div class='alert alert-warning'><h4>No results found for <b>{{type.label}}</b></h4></div>
                            {% else %}
                                {% reset_recordids as recordids %}
                                {% autopaginate type.queryset 10 as recordids %}
                                {% get_records_from_ids type recordids as records %}

                                {% filter update_query_params:type.result_type_qs %}
                                    {% paginate %}
                                {% endfilter %}

                                {% include type.template_path with template_type=type.key %}

                                {% filter update_query_params:type.result_type_qs %}
                                    {% paginate %}
                                {% endfilter %}

                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class='alert alert-warning'>
                <h4>No results found</h4>
                <p>Do you need <a href="{{ search_help_url }}">help with the search?</a></p>
            </div>
        {% endif %}

    {% endif %}

{% endblock main %}
{% block extra_js %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/chosen.jquery.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/query_sorter.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/search_page.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/forms.reset.js"></script>
    <script type="text/javascript">
	    init_search_page({{ search_page_options_json|safe }});
    </script>
{% endblock %}
