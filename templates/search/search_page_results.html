{% extends "base.html" %}
{% load pages_tags mezzanine_tags i18n %}
{% load mezzanine_tags pagination_tags html_escape %}
{% block extra_js %}
<script type="text/javascript" src="{{ STATIC_URL }}js/chosen.jquery.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/query_sorter.js"></script>
{% endblock %}
{% block main %}

{% if not submitted %}
    <div class="row-fluid">
        <h3>Please type in keyword to search for 'Hands', 'Manuscript' or 'Scribes' and use filters to narrow down your search results</h3>
    </div>
{% endif %}

<form id='searchform' class="form-inline panel" method="GET" action="/digipal/search">
    <div class='row-fluid'>
    {# {% csrf_token %} #}
      <div class='span9'>
            <div id='radio'>
                <h3 class='header5'>Search</h3>
                <ul>{{ searchform.as_ul }}</ul>
                 <script>
                    $('#radio ul').contents().unwrap();
                    $('#radio li').contents().unwrap();
                    // Then move the input to outside of the label
                    $('#radio > label > input').each(function() {
                        $(this).parent().before(this);
                    });
                    // Then apply the jQuery UI buttonset
                    $("#radio").buttonset();
                    $('#radio .ui-button-text').css('padding','.2em 1em');
                </script>  
                     
            </div>
        </div>
    </div>
         <script>
            $(document).ready(function() {

                // event onchange on radios
                var radio = $("#searchform input[type='radio']");
                radio.change(function(){
                    var container = $('#containerFilters');
                    var labelFilters = $('#labelFilters');
                    
                    content = '';
                    label = '';                       
                    if($("#searchform input[type='radio']:checked").val() == 'hands'){
                            content += '{{ filterHands.as_ul|escapejs }}';
                            label += "<h5 class='header5'>Show Hands filtered by:</h5>";
                        } else if($("#searchform input[type='radio']:checked").val() == 'manuscripts') {
                            content += '{{filterManuscripts.as_ul|escapejs}}';
                            label += "<h5 class='header5'><b>Show Manuscripts filtered by:</h5>";
                        } else {
                            content += '{{filterScribes.as_ul|escapejs}}';
                            label += "<h5 class='header5'>Show Scribes filtered by:</h5>";
                        }
                    labelFilters.html(label);
                    container.html(content);
                    
                    $('select').chosen();
               });
               radio.change();

                // Advanced Search Filters
                // open: true to show the advanced search, false to hide it.
                //       toggle display by is open is not specified. 
                function toggle_advanced_search(open, noAnimation) {
                    var isOpen = $('#advancedSearch').is(':visible');
                    if (typeof noAnimation == 'undefined') noAnimation = false;
                    if (typeof open == 'undefined') open = !isOpen;
                    if (open !== isOpen) {
                        if (noAnimation) 
                            $('#advancedSearch').toggle();
                        else
                            $('#advancedSearch').slideToggle();
                        if (open) $('select').chosen();
                    }
                    $('#advanced').text(open ? 'Hide Advanced Search' : 'Advanced Search');
                }
                $('#advanced').click(function(){toggle_advanced_search();});
                {% if advanced_search_expanded %}
                    toggle_advanced_search(true, true);
                {% endif %}
                

                $('#filtersform').hide();
                var filter = 0;
                options = {
                  'title': 'Show Graph Filters',
                  'content': 'Click this button to explore and filter graphs',
                  'trigger': 'hover'
                }
                $('#show_filters').popover(options)
                $('#show_filters').click(function(){
                  if(filter == 0){
                    $('#filtersform').slideDown();
                    $('#show_filters').attr('class', 'btn');
                    $('#show_filters').text('Hide Graphs Filters');
                    filter = 1;
                  } else {
                    $('#filtersform').slideUp();
                    $('#show_filters').attr('class', 'btn btn-success');
                    $('#show_filters').text('Show Graphs Filters');
                    filter = 0;
                  }
                  $('select').chosen();
                })

                $('[data-toggle="tooltip"]').tooltip();
                
                // If one dropdown is selected the search terms are no longer required
                $('#searchform').on('change', 'select', function(){
                    result = false; 
                    for (i = 0; i < $(this).length; i++){
                        if (($(this)[i].value != '')) {
                            result = true;
                            break;
                        }
                    }
                    $('#search-terms').attr('required', result ? false : 'required');
                });
                
                // Clicking a tab displays its content                          
                $('#myTab a').click(function (e) {
                  e.preventDefault();
                  $(this).tab('show');
                });
                                          
            });
        </script>
        <div class='container'>
            <a id='advanced' class='btn btn-link' style='margin-left:0;padding-left:0;'>Advanced Search</a>
                <div id='advancedSearch'>
                    <div id='labelFilters'></div>
                    <div id='containerFilters' class='form-inline'></div>
                </div>
        </div>
        <div class='container' id='buttonsBox'>
          <input type="submit" value="Search" class='btn btn-primary' />
           <a class='btn btn-success' id='show_filters'>Show Graphs Filters</a>
        </div>
    </form>
  
    <div class="panel" id='filtersform'>
      <h5 class='header5'>Show Graphs filtered by:</h5>
      <form class="container form-inline"  method="GET" action="/digipal/search/graph">
        <ul>{{ drilldownform.as_ul }}</ul>
   
        <div class='container'>
            <input type="submit" value="Show Graphs" class='btn btn-primary' />
            <input type='reset' class='btn' />
        </div>
    </form> 
     </div>
     
{% if submitted %}
    {% if terms %}
        <div class='breadcrumb'>
            <span>You are searching for: </span><span><b>Term</b>: {{terms}}</span>
        </div>
    {% endif %}

    <div class='container'>
        <ul class="nav nav-tabs" id='myTab'>
            <li class="{% if selected_tab == 'hands' %}active{% else %}disabled{% endif %}">
                <a href='#hands'>Hands ({{hands.count|default:'0'}})</a>
            </li>
            <li class="{% if selected_tab == 'manuscripts' %}active{% else %}disabled{% endif %}">
                <a href='#manuscripts'>Manuscripts ({{manuscripts.count|default:'0'}})</a>
            </li>
            <li class="{% if selected_tab == 'scribes' %}active{% else %}disabled{% endif %}">
                <a href='#scribes'>Scribes ({{scribes.count|default:'0'}})</a>
            </li>
        </ul>
    </div>
    
    
    {% if hands or scribes or manuscripts %}
        <div class='tabbable'>
            <div id='myTabContent' class='tab-content'>
                
                <div class='tab-pane fade {% if selected_tab == 'hands' %}active in{% endif %}' id='hands'>
                    {% if hands %}
                        <table class="table table-condensed">
                            <tr>
                                <!--<th>Scribe</th>-->
                                <th>Repository</th>
                                <th>Shelfmark</th>
                                <th>Hand</th>
                                <th>Place</th>
                                <th>Date</th>
                                <th>Catalogue Number</th>
                                <th>Actions</th>
                            </tr> 
                      
                            {% autopaginate hands 9 %}
                          
                            {% for result in hands %}
                                <tr class="{% cycle 'bgColour' '' %}">
                
                                  <td>{{ result.item_part.current_item.repository.name }}</td>
                                  <td>{{ result.item_part.current_item.shelfmark }}</td>
                                  <td>{{ result.label }}
                                  {% if result.pages.all %}
                                    <a class='imageIcon' href='/digipal/search/?terms={{ terms|spacify }}&amp;basic_search_type={{ selected_tab }}&amp;id={{ result.id }}&amp;record={{ forloop.counter }}&from_image=true' title='{{page}}'><img src="{{ STATIC_URL }}digipal/images/manuscript.jpg" alt='manuscript' data-toggle="tooltip" title='This record contains {{result.pages.count}} images' /></a> ({{result.pages.count}})
                                  {% endif %}</td>
                                  <td>{{ result.assigned_place.name }}</td>
                                  <td>{{ result.assigned_date.date }}</td>
                                  <td>{{ result.item_part.historical_item.catalogue_number }}</td>
                                  <td>
                                      {% if can_edit %}
                                      <a class="btn" href="/admin/digipal/hand/{{ result.id }}">Edit</a>
                                      {% endif %}
                                      <a class="btn btn-primary" href="/digipal/search/?terms={{ terms|spacify }}&amp;basic_search_type=hands&amp;id={{ result.id }}&amp;record={{ forloop.counter }}">View</a>
                                  </td>
                                </tr>
                            {% endfor %}
            
                            {% paginate %}
                        </table>
                    {% else %}
                        <div class='alert alert-warning'><h4>No results found for <b>Hands</b></h4></div>
                    {% endif %}
                </div>
            
                <div class='tab-pane fade {% if selected_tab == 'manuscripts' %}active in{% endif %}' id='manuscripts'>
                
                    {% if manuscripts %}
                        <table class="table table-condensed">
                            <tr>
                                <th>Index</th>
                                <th>Repository</th>
                                <th>Shelfmark</th>
                                <th>Folio(s)</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                
                            {% autopaginate manuscripts 9 %}
                            
                            {% for result in manuscripts %}
                                <tr>
                                    <td>{{ result.historical_item.catalogue_number }} 
                                        {% if result.pages.all %}
                                            <a class='imageIcon' href='/digipal/search/?terms={{ terms }}&amp;basic_search_type={{ selected_tab }}&amp;id={{ result.id }}&amp;record={{ forloop.counter }}&amp;from_image=true' title='{{page}}'>
                                                <img src="{{ STATIC_URL }}digipal/images/manuscript.jpg" data-toggle="tooltip" alt='manuscript' title='This record contains {{result.pages.count}} images' />
                                            </a> 
                                            ({{result.pages.count}})
                                        {% endif %}
                                    </td>
                                    
                                    <td>{{ result.current_item.repository.name }}</td>
                                    <td>{{ result.current_item.shelfmark }}</td>
                                    <td>{{ result.locus }}</td>
                                    <td>
                                        {% for desc in result.historical_item.description_set.all %}
                                            {{ desc.description|truncatewords:15 }}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {% if can_edit %}
                                            <a class="btn" href="/admin/digipal/itempart/{{ result.id }}">Edit</a>
                                        {% endif %}
                                        <a class="btn btn-primary" href="/digipal/search/?terms={{ terms }}&amp;basic_search_type=manuscripts&amp;id={{ result.id }}&amp;amp;record={{ forloop.counter }}">
                                            View
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            
                            {% paginate %}
                            
                        </table>
                        
                    {% else %}
                        <div class='alert alert-warning'><h4>No results found for <b>Manuscripts</b></h4></div>
                    {% endif %}
                </div>
                
                <div class='tab-pane fade {% if selected_tab == 'scribes' %}active in{% endif %}' id='scribes'>
                    
                    {% if scribes %}
                        <table class="table table-condensed">
                            <tr>
                                <th>Name</th>
                                <th>Date</th>
                                <th>Scriptorium</th>
                                <th>Actions</th>
                            </tr>
                            
                            {% autopaginate scribes 9 %}
                            
                            {% for result in scribes %}
                                <tr class="{% cycle 'bgColour' '' %}">
                                    <td>{{ result.name }} {% if result.pages.all %}
                                        <a class='imageIcon' href='/digipal/search/?terms={{ terms }}&amp;basic_search_type={{ selected_tab }}&amp;id={{ result.id }}&amp;record={{ forloop.counter }}&amp;from_image=true' title='{{page}}'><img src="{{ STATIC_URL }}digipal/images/manuscript.jpg" alt='manuscript' data-toggle="tooltip" title='This record contains {{result.pages.count}} images' /></a> ({{result.pages.count}}){% endif %}</td>
                                    <td>{{ result.date }}</td>
                                    <td>{{ result.scriptorium.name }}</td>
                                    <td>
                                            {% if can_edit %}
                                                <a class="btn" href="/admin/digipal/scribe/{{ result.id }}">Edit</a>
                                            {% endif %}
                                            <a class="btn btn-primary" href="/digipal/search/?terms={{ terms }}&amp;basic_search_type=scribes&amp;id={{ result.id }}&amp;record={{ forloop.counter }}">View</a>
                                    </td>
                                </tr>
                            {% endfor %}
                            
                            {% paginate %}
                            
                        </table>
                    {% else %}
                         <div class='alert alert-warning'><h4>No results found for <b>Scribes</b></h4></div>
                    {% endif %}
                </div>
                
            </div>
        </div>
    {% else %}
        <div class='alert alert-warning'><h4>No results found</h4></div>
    {% endif %}

{% endif %}

{% endblock main %}
