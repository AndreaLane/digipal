{% extends "base.html" %}
{% load pages_tags mezzanine_tags i18n %}
{% load mezzanine_tags pagination_tags html_escape hand_filters %}

{% block meta_title %}
    Search
    {% if terms %}({{ terms }}){% endif %}
{% endblock %}

{% block main %}

    {% if not submitted %}
        <h1 class='header1'>Search</h1>
        <p>Please type in keyword to search for {{ search_types_display }} and
         use filters to narrow down your search results</p>
    {% endif %}
    <form id='searchform' class="panel" method="GET" action="/digipal/search">
        <div class='row'>
            {# {% csrf_token %} #}
            <div class='col-md-6'>
                {{ advanced_search_form.terms }}
                
                {{ advanced_search_form.ordering }}
                {{ advanced_search_form.years }}
                {{ advanced_search_form.result_type }}
            </div>
            <div class='col-md-6'>
                {{ advanced_search_form.from_link }}
                    <a id="filter-toggler" data-target="#advancedSearch" data-toggle="collapse" 
                        {% if expanded_custom_filters %}
                                data-alt-label="Show Advanced Search" 
                                href="?from_link=false&amp;basic_search_type={{ search_type }}">
                                Hide advanced search
                        {% else %}
                                data-alt-label="Hide Advanced Search" 
                                href="?from_link=true&amp;basic_search_type={{ search_type }}">
                                Show advanced search
                        {% endif %}
                    </a>
            </div>
        </div>

        <div id='advancedSearch' class="panel collapse {% if expanded_custom_filters %}in{%endif%}">
            
            {{ advanced_search_form.basic_search_type }}
            
            <ul class="nav nav-tabs">
                {% for type in types %}
                    <li class="{% if search_type_defaulted = type.key %}active{% endif %}">
                        <a data-toggle="tab" data-target="#filter-tab" data-filter-key="{{ type.key }}"
                            href="?from_link=true&amp;basic_search_type={{ type.key }}#searchform">
                            {{ type.label }}
                        </a>
                    </li>
                {% endfor %}
            </ul>
            
            <div class="tab-content">
                <div id="filter-tab" class="tab-pane active">
                    <div id='containerFilters' class='form-inline'>
                        <ul class="list-unstyled flat-list use-chosen">
                            {{ filters_form.html|safe }}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <p>
            {# this field is only here to know that the search has been submitted #}
            {{ quick_search_form.s }}
            <input type="submit" value="Search" class='btn btn-primary' />
            <!-- a class='btn btn-default' id='show_filters'>Show Graphs Filters</a -->
        </p>
        {% comment %}
            <div id='buttonsBox'>
                <input type="submit" value="Search" class='btn btn-primary' />
                <a class='btn btn-default' id='show_filters'>Show Graphs Filters</a>
            </div>
        {% endcomment %}
    </form>

    {% comment %}
    <div class="panel" id='filtersform'>
        <h5 class='header5'>Show Graphs filtered by:</h5>
        <form class="form-inline"  method="GET" action="/digipal/search/graph">
            <ul>{{ drilldownform.as_ul }}</ul>

            <div>
                <input type="submit" value="Show Graphs" class='btn btn-primary' />
                <input type='reset' class='btn btn-default' />
            </div>
        </form>
    </div>
    {% endcomment %}

    {% if submitted %}
        {% if terms %}
            <div class='breadcrumb' id="search-breadcrumb">
                <span>You are searching for: </span>
                <span><b>Term</b>: {{terms}}</span>
            </div>
        {% endif %}

        {% if not is_empty %}
            <ul class="nav nav-tabs" id='result-types-switch'>
                {% for type in types %}
                    <li class="{% if result_type == type.key %}active{% else %}{% if not type.count %}disabled{% endif %}{% endif %}">
                        <a href='{% filter add_query_params:request.META.QUERY_STRING %}?result_type={{ type.key }}{% endfilter %}' data-toggle="tab" data-target="#{{ type.key }}">
                            {{ type.label }} ({{type.count|default:'0'}})
                        </a>
                    </li>
                {% endfor %}
            </ul>

            <div class='tabbable'>
                <div id='result-tab-content' class='tab-content'>
                    {% for type in types %}
                        <div class='tab-pane fade {% if result_type == type.key %}active in{% endif %}' id='{{type.key}}'>
                            {% if type.is_empty %}
                                {% include "digipal/empty_tab.html" with message="No result found for this search" %}
                            {% else %}
                                {% reset_recordids as recordids %}
                                {% autopaginate type.queryset 10 as recordids %}
                                {% get_records_from_ids type recordids as records %}

                                {% filter update_query_params:type.result_type_qs %}
                                    {% paginate %}
                                {% endfilter %}

                                {% include type.template_path with template_type=type.key %}

                                {% filter update_query_params:type.result_type_qs %}
                                    {% paginate %}
                                {% endfilter %}

                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class='alert alert-warning'>
                <h4>No results found</h4>
                <p>Do you need <a href="{{ search_help_url }}">help with the search?</a></p>
            </div>
        {% endif %}

    {% endif %}

{% endblock main %}
{% block extra_js %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/chosen.jquery.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/query_sorter.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/forms.reset.js"></script>
    <script type="text/javascript">
		init_search_page({{ search_page_options_json|safe }});
    </script>
{% endblock %}
