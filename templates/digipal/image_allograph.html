{% extends "base.html" %}
{% load html_escape %}

{% block meta-title %}Page Allograph{% endblock %}

{% block extra_head %}
{% if can_edit %}
  <script src="{{ STATIC_URL }}digipal/scripts/libs/jquery.tools.min.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/libs/jquery.multiselect.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/libs/openlayers/OpenLayers.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/libs/openlayers-image-annotation/annotator-helper.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/libs/openlayers-image-annotation/annotator.js"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}js/chosen.jquery.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/annotator-digipal.js"></script>
        <script type="text/javascript">
            $(document).ready(function(){
            annotator = new DigipalAnnotator('{{ MEDIA_URL }}',
                                          'x', {{ width }}, {{ height }},
                                          '{{ image_server_url }}', "{{can_edit}}");

            annotator.url_allographs = true;
            annotator.url_annotations = '../annotations';

            var request = $.getJSON('../annotations/', function(data) {
              annotator.annotations = data;
            });

            var chained = request.then(function(data){

              $('#id_allograph').change(function() {
                updateFeatureSelect();
              });

              var format = annotator.format;
              var layer = annotator.vectorLayer;
              var features_request = $.getJSON('../vectors/');

              features_request.then(function(data){
                var features = [];
                var annotations = annotator.annotations;
                for(var j in data){
                    var f = format.read(data[j])[0];
                    f.id = j;
                    for(var i in annotations){
                        var allograph = annotations[i]['feature'];
                        var graph = annotations[i]['graph'];
                        if(f.id == annotations[i]['vector_id']){
                            f.feature = allograph;
                            f.graph = graph;
                        }
                    }
                    features.push(f);
                }
                // adds all the vectors to the vector layer
                layer.addFeatures(features);                    // zooms to the max extent of the map area
                var vectors = annotator.vectorLayer.features;
             

              $("#modal_features").draggable();
              var modal = false;
              var current_feature = false;
              $("#modal_features").draggable();

              selectedAnnotations = {
                'allograph': null,
                'annotations':  []
              };

              function clean_annotations(annotation){
                var annotations = selectedAnnotations.annotations;
                for(i = 0; i < annotations.length; i++){
                  if(annotations[i].id == annotation.id){
                    annotations.splice(i, 1);
                    i--;
                    break;
                  }
                }
              }

              $('.annotation_li').click(function(event){
                  var annotation = getFeatureById($(this).data('annotation'));
                  if(selectedAnnotations.allograph !== null && selectedAnnotations.allograph != annotation.feature){
                    selectedAnnotations.allograph = null;
                    selectedAnnotations.annotations = [];
                    $('.annotation_li').removeClass('selected');
                    $('.annotation_li').data('selected', false);
                  }
                  if($(this).data('selected')){
                    clean_annotations(annotation);
                    $(this).data('selected', false);
                    $(this).removeClass('selected');
                  } else {
                    selectedAnnotations.allograph = annotation.feature;
                    selectedAnnotations.annotations.push(annotation);
                    $(this).data('selected', true);
                    $(this).addClass('selected');
                    modal = true;
                  }
                  if(modal){
                     if(selectedAnnotations.annotations.length > 1){
                      $('.myModalLabel').html(annotation.feature + " (" + selectedAnnotations.annotations.length + " selected)")
                    } else {
                      $('.myModalLabel').html(annotation.feature);
                    }
                  }
                  event.stopPropagation();
                  event.preventDefault();
                  modal = true;
                  $('#save').click(function(){

                    var features = annotator.vectorLayer.features;
                    selected_features = [];
                    for(var i = 0; i < features.length; i++){
                       for(var j = 0; j < selectedAnnotations.annotations.length; j++){
                          if(features[i].graph == selectedAnnotations.annotations[j].graph){
                             selected_features.push(features[i]);
                          }
                       }
                    }
                    for(i = 0; i < selected_features.length; i++){
                       annotator.selectedFeature = selected_features[i];
                       annotator.saveAnnotation();
                   }
                  });
                  $("#modal_features").fadeIn();
                  if(annotation){
                    if(selectedAnnotations.annotations.length > 1){
                      $('.myModalLabel').html(annotation.feature + " (" + selectedAnnotations.annotations.length + " selected)")
                    } else {
                      $('.myModalLabel').html(annotation.feature);
                    }
                   $('#hidden_hand').val(annotation.hidden_hand);
                    $('#id_hand').val(annotation.hidden_hand);
                    $('#id_allograph').val(getKeyFromObjField(annotation, 'hidden_allograph'));
                    $('#hidden_allograph').val(getKeyFromObjField(annotation, 'hidden_allograph'));
                    $('#id_display_note').val(annotation.display_note);
                    $('#id_internal_note').val(annotation.internal_note);
                      $('select').trigger('liszt:updated');
                    
                    var url = '../graph/' + annotation.graph + '/features/';
                   var features_owned = $.ajax({
                      url: url,
                      dataType: 'json',
                      cache: false,
                      type: 'GET',
                      async: false
                  });


                    features_owned.done(function(f){
                        array_features_owned = [];
                        for(var i = 0; i < f.length; i++){
                            for(var j = 0; j < f[i].feature.length; j++){
                                s = f[i].name;
                                s += ':' + f[i].feature[j];
                                array_features_owned.push(s);
                            }
                            s = '';
                        }
                    });

                var request = $.getJSON("../graph/" + annotation.graph, function(data) {
                    return data;
                });
                var features = annotator.vectorLayer.features;
                request.done(function(data){
                    var url = '../allograph/' + data.id + '/features/';
                    var allographs = $.getJSON(url);
                    var s = "<div id='box_features_container'>";
                    allographs.done(function(data){
                        $.each(data, function(idx) {
                            component = data[idx].name;
                            component_id = data[idx].id;
                            var features = data[idx].features;
                            s += "<p class='component_labels' data-id='component_" + component_id + "' style='border-bottom:1px solid #ccc'><b>" + component + "<span class='glyphicon glyphicon-resize_full'></span></b>";
                            s += "<div id='component_" + component_id + "' data-hidden='true' class='feature_containers'>";
                            $.each(features, function(idx) {
                                var value = component_id + '::' + features[idx].id;
                                var names = component + ':' + features[idx].name;
                                    if(array_features_owned.indexOf(names) >= 0){
                                        s += "<p><input checked = 'checked' type='checkbox' value='" + value + "' class='features_box' data-feature = '" + features[idx].id + "' /> " + features[idx].name;
                                    } else {
                                        s += "<p><input type='checkbox' value='" + value + "' class='features_box' data-feature = '" + features[idx].id + "'/> " + features[idx].name;
                                    }
                            });
                            s += "</p></div>";
                        });
                        s += "</div>";
                        $('#features_container').html(s);
                       
                        $('.myModal select').chosen();
                        
                        $('.component_labels').click(function(){
                            var div = $("#" + $(this).data('id'));
                            if(div.data('hidden') === false){
                                div.slideUp().data('hidden', true);
                            } else {
                                div.slideDown().data('hidden', false);
                            }
                        });
                      
                      //updateFeatureSelect(annotation.features, feature);
                      $('#modal_features .close').click(function(){
                        $("#modal_features").fadeOut();
                        $('#status').html('-');
                        modal = false;
                        selectedAnnotations.allograph = null;
                        selectedAnnotations.annotations = [];
                        $('.annotation_li').removeClass('selected');
                      });
                    $('#features_container p').click(function(){
                          var checkbox = $(this).find('input');
                          if(checkbox.is(':checked')){
                            checkbox.attr('checked', false);
                          } else {
                            checkbox.attr('checked', "checked");
                          }        
                        });
                  });
                   $('select[id!=id_feature]').chosen();
                   
                });
                
              }
              });
            });
          });
          });
      </script>
{% endif %}
<script type="text/javascript">
  function selectFeature(id) {
    window.opener.annotator.selectFeatureByIdAndCentre(id);
    window.opener.focus();
    return false;
  }
</script>
{% endblock %}

{% block main %}

<h2 class='header1'>
  {% if image.item_part.pagination %}Page{% else %}Folio{% endif %}: 
        {{image|capfirst}}
</h2>

  <ul class='nav nav-tabs'  id='top'>
          <li><a href='../'>View Manuscript</a></li>
          <li class='active'><a>Annotations by Allograph</a></li>
          <li><a href='../metadata/'>View Metadata</a></li>
          <li><a href='../copyright/'>Image Copyright</a></li>
  </ul>
<div class="annotations">
  {% if data %}
  <h3>Hands</h3>
  {% for key, allographs in data.items %}
      <h5>{{forloop.counter}}) <a class='label' href='#{{key|anchorify}}'>{{key}}</a></h5>
  {% endfor %}
  <hr />
  {% for key, allographs in data.items %}

  <div class="scribe">
    <h2 id='{{key|anchorify}}' class='header1 header' style='padding-top: 1.5%'><b>Hand</b>: {% if image.item_part.pagination %}Page{% else %}Folio{% endif %}: 
        {{image|capfirst}} - {{ key }}</h2>
    <div class='panel'>
    {% for key, annotations in allographs.items %}

    <span><a class="label label-info" href='#{{key|anchorify}}'>{{ key }}</a></span>

    {% endfor %}
    </div>
    {% for key, annotations in allographs.items %}

    <div>
      <h5 class='header5' style='font-size:14px;' id='{{key|anchorify}}'>{{ key }}</h5>
      <ul>
        {% for annotation in annotations %}
        <li class='annotation_li' data-annotation = "{{ annotation.vector_id }}">
        <p>
        <a  href="/digipal/page/{{ annotation.image.id }}/?vector_id={{ annotation.vector_id }}">View</a>
        </p>
        <a href="/digipal/page/{{ annotation.image.id }}/?vector_id={{ annotation.vector_id }}" onclick="selectFeature('{{ annotation.vector_id}}');">
        {{ annotation.thumbnail }}
        </a>
        </li>
        {% if can_edit and forloop.last %}
          <span class='label label-info'>{{forloop.counter}}</span>
        {% endif %}
        {% endfor %}
       
      </ul>
    </div>
    {% endfor %}
  </div>
  {% endfor %}
</div>
<div><a id='ontop' href='#top' title='Back to Top'></a></div>
{% else %}
<div class='alert alert-warning'>No annotations available.</p>
{% endif %}
{% if can_edit %}
<div class="myModal" id='modal_features'>
  <div class="modal_header">
    <form id="frmAnnotation" method="get" name="frmAnnotation"><div class='ann_form'><input type='button' class='btn btn-success' value='Save' id='save' /> </div><i class='icon icon-remove close'></i>
    <p class="myModalLabel"> </p>
    <p style='border-top:1px solid #efefef;padding-top:2%'></p>
  </div>
  <div class="modal-body">
    <p id='status'></p>
        {% for field in form %}
            <p>
            {{ field.label_tag }}
            {{ field }}
            </p>
          {% endfor %}
            <div id='features_container'></div>

  </div>
  </form>
</div>
              
{% endif %}
{% endblock %}

