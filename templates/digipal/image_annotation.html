{% extends "base.html" %}
{% load html_escape %}

{% block meta_title %}
    {% if image.item_part.pagination %}Page{% else %}Folio{% endif %}:
    {{image|capfirst}}
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/bootstrapSwitch.css" />
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}digipal/scripts/libs/openlayers.digipal/theme/default/style.css"/>
{% endblock %}

{% block main %}
    <h2 class='header1'>
        {% if image.item_part.pagination %}Page{% else %}Folio{% endif %}:
        <a href="{{ image.item_part.get_absolute_url }}">{{ image.item_part|capfirst }}</a>: {{ image.locus }}
        {% include "digipal/admin_edit.html" with instance=image %}
    </h2>

    {% if no_image_reason %}
        <p>
            {{ no_image_reason }}
        </p>
    {% endif %}
    {% if not no_image_reason or can_edit %}

            <input id="id_page" name="page" type="hidden" value="{{ image.id }}" />

            <div class='row'>

                {% comment %} TABS {% endcomment %}
                <div class='span8'>
                    <ul class='nav nav-tabs'>
                        <li {% if url == image.id|slugify or url == 'allographs' %} class='active in' {% endif %}>
                            <a data-toggle="tab" data-target='#annotator' href='/digipal/page/{{ image.id }}'>Manuscript Image</a>
                        </li>
                        <li {% if annotations == 0 %} class='disabled' {% endif %}>
                            <a data-toggle="tab" class="annotationLink" data-target='#allographs' href="/digipal/page/{{ image.id }}/allographs/">Annotations by Allograph ({{annotations}})</a>
                        </li>
                        <li {% if url == 'metadata' %} class='active in' {% endif %}>
                            <a data-toggle="tab" data-target='#metadata' href='/digipal/page/{{ image.id }}/metadata'>Metadata</a>
                        </li>
                        <li {% if url == 'copyright' %} class='active in' {% endif %}>
                            <a data-toggle="tab" data-target='#copyright' href='/digipal/page/{{ image.id }}/copyright/'>Image Copyright</a>
                        </li>
                        <li {% if url == 'pages' %} class='active in' {% endif %}>
                            <a {% if image.item_part.images.all.count == 1 %} class='disabled' {% endif %} data-toggle="tab" data-target="#pages" href='/digipal/page/{{ image.id }}/pages/'>Other Pages ({{ image.item_part.images.all.count|add:'-1' }})</a>
                        </li>
                    </ul>
                </div>

            </div> {% comment %}DIV row{% endcomment %}
            <div class="tabbable">
                <div class="tab-content">
                    <div class="tab-pane fade {% if url == image.id|slugify or url == 'allographs' %} active in {% endif %}" id='annotator'>
                        {% include "digipal/image_annotation_control_bar.html" %}
                        <div id="map"></div>
                        <div id="toolbar" class="olControlEditingToolbar"></div>
                        {% include "digipal/image_annotation_settings.html" %}
                        <div id='annotations'></div>
                        <div class='row-fluid' id='allographs_filtersBox'></div>

                    </div>

                    <div class="tab-pane fade" id='allographs'>
                        {% include "digipal/hands.html" %}
                    </div>

                    <div class="tab-pane fade {% if url == 'metadata' %} active in {% endif %}" id='metadata'>
                         {% include "pages/record_images.html" %}
                    </div>

                    <div class="tab-pane fade {% if url == 'copyright' %} active in {% endif %}" id='copyright'>
                        {% include "pages/copyright.html" %}
                    </div>

                    <div class="tab-pane fade {% if url == 'pages' %} active in {% endif %}" id='pages'>
                        {% include "digipal/image_annotation_other_images.html" %}
                    </div>

                </div>

            </div>

            <p id='status'></p>

    {% endif %}
{% endblock %}

{% block extra_js %}
    <script src="{{ STATIC_URL }}scripts/bootstrapSwitch.js"></script>
    <script src="{{ STATIC_URL }}digipal/scripts/libs/openlayers/OpenLayers.js"></script>
    <script src="{{ STATIC_URL }}digipal/scripts/libs/openlayers-image-annotation/annotator-helper.js"></script>
    <script src="{{ STATIC_URL }}digipal/scripts/libs/openlayers-image-annotation/annotator.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/chosen.jquery.js"></script>
    <script src="{{ STATIC_URL }}digipal/scripts/annotator-digipal.js"></script>
    <script src="{{ STATIC_URL }}digipal/scripts/stored-inputs.js"></script>
    <script src="{{ STATIC_URL }}digipal/scripts/add_to_lightbox.js"></script>
    <script src='https://apis.google.com/js/client.js'></script>
    <script>

        var csrftoken = getCookie('csrftoken');
        $.ajaxSetup({
            headers: { "X-CSRFToken": csrftoken }
        });

        $(document).ready(function() {
            var si = new StoredInputs('digipal_settings');
            si.registerInput('#ontograph_type');
            var url = "{{ url }}";
            var image_id = "{{ image.id }}";
            if(url == image_id || url == 'allographs'){
                main();
                $('a[data-target="#allographs"').tab('show');
            }

            var tabs = $('a[data-toggle="tab"]');

            tabs.on('shown', function(e) {
                var dialog = $('.ui-dialog');
                if (e.target.getAttribute('data-target') != '#annotator') {

                    if (window.history && window.history.pushState) {
                        history.pushState(null, null, $(this).attr('href'));
                    } else {
                        window.location.href = $(this).attr('href');
                    }

                    if (dialog.length) {
                        dialog.fadeOut();
                    }

                } else {

                    if(typeof annotator.annotations == 'undefined'){
                        main();
                    }

                    if (dialog.length) {
                        dialog.fadeIn();
                    }

                    history.pushState(null, null, '/digipal/page/' + annotator.image_id);
                }
                return false;
            });
        });

        function main(){
                annotator = new DigipalAnnotator('{{ MEDIA_URL }}',
                'x', {{ width }}, {{ height }},
                '{{ image_server_url }}', "{{is_admin}}");

                {% if not is_admin %}
                annotator.toolbarPanel.controls.splice(4, 4);
                annotator.toolbarPanel.redraw();
                annotator.user_annotations = [];
                annotator.boxes_on_click = true;
                {% endif %}

                annotator.image_id = {{ image.id }};
                annotator.hands = {{ hands_list|safe }}
                annotator.url_annotations = '/digipal/page/{{ image.id }}/annotations';
                no_image_reason = false;

                {% if vector_id %}
                vector_id = true;
                vector_id_value = (getParameter('vector_id'));
                {% else %}
                vector_id = false;
                {% endif %}

                {% if no_image_reason %}
                no_image_reason = true;
                {% endif %}

                {% if request.GET.annotations == "false" %}
                get_annotations = "false"
                {% else %}
                get_annotations = "true"
                {% endif %}

                /* Calling page script */

                if(annotator){
                    $.getScript("{{ STATIC_URL }}digipal/scripts/annotator-page-script.js");
                    if(annotator.isAdmin == 'True'){
                        $.getScript('{{ STATIC_URL }}digipal/scripts/allographs.js');
                    } else {
                        $.getScript('{{ STATIC_URL }}digipal/scripts/allographs-public-user.js');
                    }
                }
            }
    </script>
{% endblock %}