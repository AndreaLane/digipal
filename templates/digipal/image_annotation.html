{% extends "base.html" %}
{% load html_escape %}
    {% block extra_css %}
        <link rel="shortcut icon"
            href="{{ STATIC_URL }}digipal/images/favicon.ico"/>
     
        <link rel="stylesheet" href="{{ STATIC_URL }}css/bootstrapSwitch.css" />
        <link rel="stylesheet" type="text/css"
            href="{{ STATIC_URL }}digipal/scripts/libs/openlayers.digipal/theme/default/style.css"/>
    {% endblock %}
    {% block extra_js %}
        <script src="{{ STATIC_URL }}digipal/scripts/libs/jquery.tools.min.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/libs/jquery.multiselect.js"></script>
        <script src="{{ STATIC_URL }}scripts/bootstrapSwitch.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/libs/openlayers/OpenLayers.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/libs/openlayers-image-annotation/annotator-helper.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/libs/openlayers-image-annotation/annotator.js"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}js/chosen.jquery.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/annotator-digipal.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/stored-inputs.js"></script>

        <script>
          
          var csrftoken = getCookie('csrftoken');
          $.ajaxSetup({
              headers: { "X-CSRFToken": csrftoken }
          });

        </script>
         <script>
            $(document).ready(function() {
              var si = new StoredInputs('digipal_settings');
              si.registerInput('#ontograph_type');

              annotator = new DigipalAnnotator('{{ MEDIA_URL }}',
                                              'x', {{ width }}, {{ height }},
                                              '{{ image_server_url }}', "{{is_admin}}");

              {% if not is_admin %}
              annotator.toolbarPanel.controls.splice(3, 5);
              annotator.toolbarPanel.redraw();
              {% endif %}
              annotator.dragFeature.handlers.drag.keyMask = OpenLayers.Handler.MOD_SHIFT;
              annotator.zoomBoxFeature.keyMask = OpenLayers.Handler.MOD_CTRL;
            annotator.activateKeyboardShortcuts();
            annotator.hands = {{hands_list}};
            var request = $.getJSON('annotations/', function(data) {
                annotator.annotations = data;
            });
            var chained = request.then(function(data){
              var map = annotator.map;
              var layer = annotator.vectorLayer;
              var format = annotator.format;
              var annotations = data;

              var features_request = $.getJSON('vectors/');
              features_request.then(function(data){
                  var features = [];
                  for(var j in data){
                      var f = format.read(data[j])[0];
                      f.id = j;
                      for(var i in annotations){
                          var allograph = annotations[i]['feature'];
                          var character_id = annotations[i]['character_id'];
                          var graph = annotations[i]['graph'];
                          var character = annotations[i]['character'];
                          var hand = annotations[i]['hand'];
                          var image_id = annotations[i]['image_id'];
                          if(f.id == annotations[i]['vector_id']){
                              f.feature = allograph;
                              f.character_id = character_id;
                              f.graph = graph;
                              f.character = character;
                              f.hand = hand;
                              f.image_id = image_id;
                              f.stored = true;
                          }
                      }
                      features.push(f);
                  }
                  // adds all the vectors to the vector layer
                  layer.addFeatures(features);

                  // zooms to the max extent of the map area
                  map.zoomIn();
                  var vectors = annotator.vectorLayer.features;
                  {% if vector_id %}
                  // vectorLayer event moveend is triggered on first load so flag this
                  initialLoad = true;
                  vector_id = true;
                  
                  // tries to centre the map every 1/2 second
                  //interval = setInterval(function() {
                  //}, 500);
        
                  /* listen for the moveend event
                  annotator.vectorLayer.events.register('moveend', 
                      annotator.vectorLayer, function() {
                      // checks if it is a first load, if not kill the interval
                      if (initialLoad) {
                        initialLoad=false
                      } else {
                        clearInterval(interval);
                        annotator.vectorLayer.events.remove('moveend');
                      }
                  });
                  */    
                  annotator.selectFeatureByIdAndCentre('{{ vector_id }}');
                  annotator.selectFeatureByIdAndZoom('{{ vector_id }}');                  
                  reload_described_annotations();

            {% else %}
                  reload_described_annotations();
            {% endif %}

            function getParameter(paramName) {
              var searchString = window.location.search.substring(1),
                i, val, params = searchString.split("&");
              var parameters = [];
              for (i = 0; i < params.length; i++) {
                var val = params[i].split("=");
                if (val[0] == paramName) {
                  parameters.push(unescape(val[1]));
                }
              }
              return parameters;
            }

            var temporary_vectors = getParameter('temporary_vector');
            if (temporary_vectors.length){
              var geoJSON = new OpenLayers.Format.GeoJSON();
              var temporary_vector = getParameter('temporary_vector');
              for(i = 0; i < temporary_vector.length; i++){
                var object = geoJSON.read(temporary_vector[i]);
                var objectGeometry = object[0];
                objectGeometry.layer = annotator.vectorLayer;
                objectGeometry.style = {
                  'fillColor': 'red',
                  'strokeColor': 'red',
                  "fillOpacity" : 0.4
                };
                objectGeometry.described = false;
                objectGeometry.stored = false;
                annotator.vectorLayer.features.push(object[0]);
                annotator.selectFeatureByIdAndZoom(objectGeometry.id);
              }               
            }

            });
            allographs_box = false;
            allographs_loaded = false;
            $('#filterAllographs').click(function(){
              var find_hands = $.ajax({
                url: 'hands_list/',
                dataType: 'json',
                data: {'hands': JSON.stringify(annotator.hands)}
              });

              find_hands.done(function(data){
                console.log(data);
                $(this).addClass('active');
                if(!allographs_box){
                    allographs_box = true;
                    var checkOutput = '<ul class="span6" style="padding:2%;"><span class="btn pull-left" id="checkAll">All</span> <span class="btn pull-right" id="unCheckAll">Clear</span><br clear="all" />';       
                    var annotations = annotator.annotations;
                    if(!isEmpty(annotations)){
                      list = [];
                      vectors = [];
                      for (var i in annotations){
                          list.push(annotations[i]['feature']);
                      }
                      list.sort();
                      vectors.sort();
                      for(var h = 0; h < list.length; h++){
                          checkOutput += "<li style='padding:2%;' data-annotation = '" + list[h] + "'>" +
                          "<input checked='checked' value = '" + list[h] + "' class='checkVectors' id='" + vectors[h] + "' type='checkbox' /> <label style='display:inline;'>" + list[h] + "</label></li>";
                      }
                    }
                    checkOutput += "</ul>";
                                      

                    $('#allographs_filtersBox').dialog({
                      draggable: true, 
                      height: 300,
                      resizable: true,
                      width:320,
                      title: "Filter Annotations",
                      closeOnEscape: false,
                      dialogClass: 'no-close'
                    });
                    $('#ui-dialog-title-allographs_filtersBox').after("<span title='' class='pin-filters-box pull-right'>-</span>")
                    annotator.removeDuplicate('allographs_filtersBox li', 'data-annotation', false);
                    $('#allographs_filtersBox').html(checkOutput)
                    annotator.removeDuplicate('#allographs_filtersBox li', 'data-annotation', false);
                    $('.checkVectors').change(function(){
                      annotator.filterAnnotation($(this));
                    });
                    $('#checkAll').click(function(){
                      annotator.filterCheckboxes('.checkVectors', 'check');
                    });
                    $('#unCheckAll').click(function(){
                      annotator.filterCheckboxes('.checkVectors', 'uncheck');
                    });

                    $('.pin-filters-box').click(function(){
                      $('#filterAllographs').removeClass('active');
                      $(this).parent().parent().fadeOut();
                    });

                  } else {
                    $('.pin-filters-box').parent().parent().fadeIn();
                  }
                
              });
             });
            $('#map').css('border','1px solid #efefef');
            $('#map').css('border-radius','3px');
            //$("a[data-toggle=tooltip]").tooltip()
            $('#toggle-state-switch').bootstrapSwitch('toggleState');
            var showImages = 0;
            $('#showImages').click(function(){
              if(showImages == 0){
                position = $(this).position();
                $('#popupImages').css('top', position['top'] + 40);
                $('#popupImages').css('left', position['left'] - 40);
                $('#popupImages').fadeIn();
                showImages = 1;
              } else {
                $('#popupImages').fadeOut();
                showImages = 0;
              }
            });
            
      
            $('#closeBox').click(function(){
              $('#popupImages').fadeOut();
            });
      
            $('#toggle-state-switch').on('click', function () {
                $('#toggle-state-switch').bootstrapSwitch('toggleState');
            });
      
      
            $('#toggle-state-switch').on('switch-change', function (e, data) {
                if($(this).bootstrapSwitch('status')){
                  annotator.vectorLayer.setVisibility(true)
                } else {
                  annotator.vectorLayer.setVisibility(false)
                }
            });
      
            {% if request.GET.annotations == "false" %}
              $('#toggle-state-switch').bootstrapSwitch('toggleState');
            {% endif %}
          
            var modal = false;
            $("#modal_features").draggable({
              zIndex: 1005,
              stack: ".ui-dialog"
            });
            $('#editGraph').click(function(){
              if(modal){
                modal = false;
                $("#modal_features").fadeOut();
              } else {
                modal = true;
                $("#modal_features").fadeIn();
                $('#modal_features .close').click(function(){
                  $("#modal_features").fadeOut();
                  modal = false;
                });
              }
            });
            
           
            
            /* Set up the Settings Modal */
            var modal_settings = false;
            $('#settings_annotator').click(function(){
              if (modal_settings) {
                modal_settings = false;
                $("#modal_settings").fadeOut();
              } else {
                modal_settings = true;
                $('#modal_settings').dialog({
                    draggable: true, 
                    height: 500,
                    resizable: true,
                    width:320,
                    title: "Settings",
                    close: function(event, ui){
                        modal_settings = false;
                        $("#modal_settings").fadeOut();
                    }
                });
              }
            });
            
        	// Filter the allograph by ontograph type.
            // Each time an ontograph type is selected in the settings,
            // we enable only the relevant options in the allograph Select. 
            $("#ontograph_type").change(function(event) {
            	var type_id = $(event.target).val();
            	if (type_id == '0') {
                	$('#id_allograph option').removeAttr('disabled');
            	} else {
                	$('#id_allograph option').attr('disabled', 'disabled');
                	$('#id_allograph option[class=type-'+type_id+']').removeAttr('disabled');
            	}
            	$('#id_allograph').trigger("liszt:updated");
              highlight_vectors();
            });
            // Filter just after page is loaded.
            $("#ontograph_type").change();
            
            allow_multiple_dialogs = false;
            $('#multiple_boxes').change(function(){
              if($(this).is(':checked')){
                allow_multiple_dialogs = true;
              } else{
                allow_multiple_dialogs = false;
              }
            });

             $('input[name=toolbar_position]').change(function(){
              if($(this).val() == "Vertical"){
                $('.olControlEditingToolbar')[0].style.setProperty("position", "fixed", "important");
                $('.olControlEditingToolbar').css({
                  "position": "fixed !important",
                  "left": "0px",
                  "top": "245px",
                  "width": "30px",
                  "z-index": 1000
                });
              } else{
                $('.olControlEditingToolbar')[0].style.setProperty("position", "absolute", "important");
                $('.olControlEditingToolbar').css({
                  "left": "72%",
                  "top": 0,
                  "width": "320px",
                  "z-index": 1000
                });
              }
            });

           });          

            $('#modal_features').click(function(){
              $(this).focus();
            });
             $('.ui-dialog').click(function(){
              $(this).focus();
            });
           
             $('#save').click(function(){
              annotator.saveAnnotation();
             });

            $('#refresh_layer').click(function(){
              refresh_layer();
            });
            var can_edit = $('#development_annotation');
            can_edit.on('change', function(){
              if($(this).is(':checked')){
                $('#multiple_boxes').attr('disabled', 'disabled');
              } else {
                $('#multiple_boxes').attr('disabled', false);

              }
            });
    $('#id_allograph').on('change', function() {
      updateFeatureSelect();
      refresh_letters_container($("#id_allograph option:selected").text(), $(this).val());
    });

    $('#id_hand').on('change', function() {
      $('#hidden_hand').val($(this).val());
    });

    $('.number_annotated_allographs').click(function() {
      open_allographs();
    });

    annotator.rectangleFeature.events.register('featureadded', annotator.rectangleFeature,
  findRectangleFeaturAadded);
  function findRectangleFeaturAadded(feature) {
    annotator.selectFeatureById(feature.feature.id);
  }

  $('#boxes_on_click').on('change', function(){
    if($(this).is(':checked')){
      annotator.boxes_on_click = true;
    } else {
      annotator.boxes_on_click = false;

    }
  });

     $("#id_allograph").on("liszt:ready", function(){
        highlight_vectors();
      });
    $('select[id!=id_feature]').chosen();

    if($('#boxes_on_click').is(':checked')){
      annotator.boxes_on_click = true;
    }
            
        });
    </script>     
    {% endblock %}

{% block annotations %}
<div class='container'>
    <h2 class='header1'>
        {% if image.item_part.pagination %}Page{% else %}Folio{% endif %}: 
        {{image|capfirst}}
    </h2>
    {% if no_image_reason %}
        <p>
            {{ no_image_reason }}
        </p>
    {% endif %}
    {% if not no_image_reason or can_edit %}
          <input id="id_page" name="page" type="hidden" value="{{ image.id }}" />
        <div class='row'>
          <div class='span7'>
              <ul class='nav nav-tabs'>
                <li class='active'><a>View Manuscript</a></li>
                <li><a class="annotationLink" href="allographs/">Annotations by Allograph</a></li>
                <li><a href='metadata/'>View Metadata</a></li>
                <li><a href='copyright/'>Image Copyright</a></li>
              </ul>
          </div>
          <div class='span3 pull-right'>
            <span id='showImages' data-toggle="tooltip" title="Show images" class="alert alert-success" style='line-height:3;cursor:pointer;'>This manuscript has {{ image.item_part.images.count }}
             {% if image.item_part.images.count == 1 %} 
              <span style='font-weight:bold'>image</span></span>
              {% else %}
              <span style='font-weight:bold'>images</span></span>
              {% endif %}          
                <div id='popupImages' class="row-fluid">
                  <div class='arrow'></div>
                  <div id='titlePopup'><p>Manuscript Images<span title='Close Window' id='closeBox' class='pull-right'><i class='icon icon-remove'></i></span></p> </div>
                  <div class='span12' id='imagesBoxcontent'>
                    {% for p in image.item_part.images.all %}
                    {% if image.item_part.images.count == 1 %}
                      <p>
                        <a data-annotations='{{ p.annotation_set.all.count }}' data-hands='{{image.hands.all.count}}' style='margin-left: 13%;' title="{{p}}" class="span8 imagesBoximage" href = "#">{{ p.thumbnail|safe }}
                            </a>
                          </p>
                      {% elif image.item_part.images.count < 3 %}
                          <a data-annotations='{{ p.annotation_set.all.count }}' data-hands='{{image.hands.all.count}}' title="{{p}}" class="span5 imagesBoximage" href = "../{{ p.id|safe}}/">{{ p.thumbnail|safe }}
                            </a>
                      {% else %}
                        {% if forloop.counter|divisibleby:3 %}
                          <div class='row'>
    
                           <a style='margin-left:1.1%;' data-annotations='{{ p.annotation_set.all.count }}' data-hands='{{image.hands.all.count}}' title="{{p}}" class="span3 imagesBoximage" href = "../{{ p.id|safe}}/">{{ p.thumbnail|safe }}</a>
                          </div>
                      {% else %}
                          <a title='{{p}}' data-annotations='{{ p.annotation_set.all.count }}' data-hands='{{image.hands.all.count}}' class="span3 imagesBoximage" href = "../{{ p.id|safe}}/">{{ p.thumbnail|safe }}</a>
         
                    {% endif %}
                    {% endif %}
                {% endfor %}
                </div>                  
              </div>
            </div>
          </div>
              <div class='panel' id='panelImageBox' style='padding:1%;'>
                <span><b>Annotations</b>: <span class="badge badge-important">{{ annotations }}</span></span>
                <span><b>Hands</b>: <span class="badge badge-success">{{ hands }}</span></span>
                {% if annotations > 0 %}
                <span><b>Annotations:</b>
                  <span id="toggle-state-switch" class="switch switch-small">
                    <input type="checkbox" />
                  </span>
                </span>
    
                <span>
                  <a class='btn' id='filterAllographs'>Filter</a>
                </span>
                {% endif %}

                <span>
                    <a class="btn" id="settings_annotator">Settings</a>
                </span>
            </div>  
            {% if can_edit %}
                <form name='frmAnnotation' method="get" id='frmAnnotation'>
                  <p style='margin-top:2%' id='form_annotation_hand'>{{ form }}
                  <span class='btn btn-small btn-primary number_annotated_allographs' data-feature = '' title='Show all the images of this allograph'><i class= 'icon-eye-open'></i> <span class='number-allographs'></span></span></p>
                </form>
            {% endif %}


            <div>
              <p id='status'></p>
            </div>
            
              <div class='container'>
                  <div id="map"></div>
                  <div id="toolbar" class="olControlEditingToolbar"></div>
              </div>
              
                <div id='modal_settings' style="display:none;">
                      <p>
                        <label>Annotation boxes</label>
                        <span>Allow multiple boxes <input style='margin-left:4%;margin-bottom: 1%;' type='checkbox' id='multiple_boxes' {% if can_edit %} disabled {% endif %} /></span> 
                      </p>
                      <p>
                        <label>Toolbar position</label>
                          <span>Vertical <input style='margin-left:4%;margin-bottom: 1%;' type='radio' name='toolbar_position' id='vertical' value='Vertical' checked /></span><br />
                          <span>Horizontal <input style='margin-left:4%;margin-bottom: 1%;' type='radio' name='toolbar_position' id='horizontal' value='Horizontal'  /></span>
                      </p>
                      <p>
                        <label>Boxes</label>
                        <span>Open Boxes on click <input style='margin-left:4%;margin-bottom: 1%;' type='checkbox'  id='boxes_on_click' {% if not can_edit %} checked {% endif %} /></span> 
                      </p>
                      {% if can_edit %}

                      <p>
                        <label>Admin</label>
                        <span>Annotating <input style='margin-left:4%;margin-bottom: 1%;' type='checkbox'  id='development_annotation' checked /></span>
                        </p>
                        <p>
                       <label>Filter allographs: </label>
                            <select id="ontograph_type" name="ontograph_type">
                                <option value="0">Show all</option>
                                {% for type in ontograph_types %}
                                    <option value="{{ type.id }}">{{ type.name }}</option>
                                {% endfor %}
                            </select>
                        </span> 
                      </p>
                  {% endif %}
                         
                          
                      {% endif %}
                </div>
                 </div>
              </div>
              <div id='annotations'></div>

</div>


{% if not no_image_reason or can_edit %}

    <div class='row-fluid' id='allographs_filtersBox'></div> 
    <!-- Modal -->


{% endif %}
     
{% endblock %}

