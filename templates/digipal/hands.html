{% load pages_tags mezzanine_tags i18n %}
{% load mezzanine_tags pagination_tags hand_filters %}
{% load html_escape %}

{% block extra_head %}
{% if can_edit %}
  <script src="{{ STATIC_URL }}digipal/scripts/libs/jquery.tools.min.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/libs/jquery.multiselect.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/libs/openlayers/OpenLayers.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/libs/openlayers-image-annotation/annotator-helper.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/libs/openlayers-image-annotation/annotator.js"></script>
        <script type="text/javascript" src="{{ STATIC_URL }}js/chosen.jquery.js"></script>
        <script src="{{ STATIC_URL }}digipal/scripts/annotator-digipal.js"></script>
        <script type="text/javascript">
            $(document).ready(function(){

            annotator = new DigipalAnnotator('{{ MEDIA_URL }}',
                                          'x', {{ width }}, {{ height }},
                                          '{{ image_server_url }}', "{{can_edit}}");
            annotator.hands_page = "{{hands_page}}";
            annotator.url_allographs = true;
            annotator.url_annotations = '../annotations';

            if (annotator.hands_page == "True"){
              annotator.url_annotations = '/digipal/page/61/annotations/';
            }
            var request = $.getJSON(annotator.url_annotations, function(data) {
              annotator.annotations = data;
            });

            var chained = request.then(function(data){

              $('#id_allograph').change(function() {
                updateFeatureSelect();
              });

              var format = annotator.format;
              var layer = annotator.vectorLayer;
              var url_vectors = '../vectors/';
              if (annotator.hands_page == "True"){
                url_vectors = '/digipal/page/61/vectors/';
              }
              var features_request = $.getJSON(url_vectors);

              features_request.then(function(data){
                var features = [];
                var annotations = annotator.annotations;
                for(var j in data){
                    var f = format.read(data[j])[0];
                    f.id = j;
                    for(var i in annotations){
                        var allograph = annotations[i]['feature'];
                        var graph = annotations[i]['graph'];
                        if(f.id == annotations[i]['vector_id']){
                            f.feature = allograph;
                            f.graph = graph;
                        }
                    }
                    features.push(f);
                }
                // adds all the vectors to the vector layer
                layer.addFeatures(features);                    // zooms to the max extent of the map area
                var vectors = annotator.vectorLayer.features;
             

              $("#modal_features").draggable();
              var modal = false;
              var current_feature = false;
              $("#modal_features").draggable();

              selectedAnnotations = {
                'allograph': null,
                'annotations':  []
              };

              function clean_annotations(annotation){
                var annotations = selectedAnnotations.annotations;
                for(i = 0; i < annotations.length; i++){
                  if(annotations[i].id == annotation.id){
                    annotations.splice(i, 1);
                    i--;
                    break;
                  }
                }
              }

              $('.annotation_li').click(function(event){
                  var annotation = getFeatureById($(this).data('annotation'));
                  if(selectedAnnotations.allograph !== null && selectedAnnotations.allograph != annotation.feature){
                    selectedAnnotations.allograph = null;
                    selectedAnnotations.annotations = [];
                    $('.annotation_li').removeClass('selected');
                    $('.annotation_li').data('selected', false);
                  }
                  if($(this).data('selected')){
                    clean_annotations(annotation);
                    $(this).data('selected', false);
                    $(this).removeClass('selected');
                  } else {
                    selectedAnnotations.allograph = annotation.feature;
                    selectedAnnotations.annotations.push(annotation);
                    $(this).data('selected', true);
                    $(this).addClass('selected');
                    modal = true;
                  }
                  if(modal){
                     if(selectedAnnotations.annotations.length > 1){
                      $('.myModalLabel .label-modal-value').html(annotation.feature + " (" + selectedAnnotations.annotations.length + " selected)")
                    } else {
                      $('.myModalLabel .label-modal-value').html(annotation.feature);
                    }
                  }
               
                  modal = true;
                  $('#save').click(function(){
                    var features = annotator.vectorLayer.features;
                    selected_features = [];
                    for(var i = 0; i < features.length; i++){
                       for(var j = 0; j < selectedAnnotations.annotations.length; j++){
                          if(features[i].graph == selectedAnnotations.annotations[j].graph){
                             selected_features.push(features[i]);
                          }
                       }
                    }
                    for(i = 0; i < selected_features.length; i++){
                       annotator.selectedFeature = selected_features[i];
                       annotator.saveAnnotation();
                   }
                  });

                  $('#delete').click(function(){
                    var features = annotator.vectorLayer.features;
                    selected_features = [];
                    for(var i = 0; i < features.length; i++){
                       for(var j = 0; j < selectedAnnotations.annotations.length; j++){
                          if(features[i].graph == selectedAnnotations.annotations[j].graph){
                             selected_features.push(features[i]);
                          }
                       }
                    }
                    var j = 0;
                    for(i = 0; i < selected_features.length; i++){
                      
                      annotator.deleteAnnotation(annotator.vectorLayer, selected_features[i]);
                      
                     
                    }
                    });
                      
                    

                  $("#modal_features").fadeIn();
                  if(annotation){
                    if(selectedAnnotations.annotations.length > 1){
                      $('.myModalLabel .label-modal-value').html(annotation.feature + " (" + selectedAnnotations.annotations.length + " selected)")
                    } else {
                      $('.myModalLabel .label-modal-value').html(annotation.feature);
                    }
                   $('#hidden_hand').val(annotation.hidden_hand);
                    $('#id_hand').val(annotation.hidden_hand);
                    $('#id_allograph').val(getKeyFromObjField(annotation, 'hidden_allograph'));
                    $('#hidden_allograph').val(getKeyFromObjField(annotation, 'hidden_allograph'));
                    $('#id_display_note').val(annotation.display_note);
                    $('#id_internal_note').val(annotation.internal_note);
                      $('select').trigger('liszt:updated');
                    if (annotator.hands_page == "True"){
                     url = '/digipal/graph/' + annotation.graph + '/features/';
                    }
                   var url = '../graph/' + annotation.graph + '/features/';
                   var features_owned = $.ajax({
                      url: url,
                      dataType: 'json',
                      cache: false,
                      type: 'GET',
                      async: false
                  });


                    features_owned.done(function(f){
                        array_features_owned = [];
                        for(var i = 0; i < f.length; i++){
                            for(var j = 0; j < f[i].feature.length; j++){
                                s = f[i].name;
                                s += ':' + f[i].feature[j];
                                array_features_owned.push(s);
                            }
                            s = '';
                        }
                    });

                $('#id_display_note').parent('p').hide()
                $('#id_internal_note').parent('p').hide()
                var url_features = "../graph/" + annotation.graph;
                if (annotator.hands_page == "True"){
                  var url_features = "/digipal/page/61/graph/" + annotation.graph;
                }
                var request = $.getJSON(url_features, function(data) {
                    return data;
                });

                var features = annotator.vectorLayer.features;
                request.done(function(data){
                    var url = '../allograph/' + data.id + '/features/';
                    if (annotator.hands_page == "True"){
                      var url = "/digipal/page/61/allograph/" + data.id + '/features/';
                    }
                    var allographs = $.getJSON(url);
                    var s = "<div id='box_features_container'>";
                    allographs.done(function(data){
                        $.each(data, function(idx) {
                            component = data[idx].name;
                            component_id = data[idx].id;
                            var features = data[idx].features;
                            s += "<p class='component_labels' data-id='component_" + component_id + "' style='border-bottom:1px solid #ccc'><b>" + component + " <span class='arrow_component icon-arrow-down'></span></span></b>";
                            s += "<div class='checkboxes_div pull-right' style='margin: 1%;'><button class='check_all btn btn-small'>All</button> <button class='btn btn-small uncheck_all'>Clear</button></div><div>";

                            s += "<div id='component_" + component_id + "' data-hidden='true' class='feature_containers'>";
                            $.each(features, function(idx) {
                                var value = component_id + '::' + features[idx].id;
                                var names = component + ':' + features[idx].name;
                                    if(array_features_owned.indexOf(names) >= 0){
                                        s += "<p><input checked = 'checked' type='checkbox' value='" + value + "' class='features_box' id='" + features[idx].id + "' data-feature = '" + features[idx].id + "' /> <label style='font-size:12px;display:inline;' for='" + features[idx].id + "'>" + features[idx].name + "</label>";
                                    } else {
                                        s += "<p><input id='" + features[idx].id + "' type='checkbox' value='" + value + "' class='features_box' data-feature = '" + features[idx].id + "'/> <label style='font-size:12px;display:inline;' for='" + features[idx].id + "'>" + features[idx].name + "</label>";
                                    }
                            });
                            s += "</p></div>";
                        });
                        s += "</div>";
                        $('#features_container').html(s);
                        $('.check_all').click(function(){
                          var checkboxes = $(this).parent().next().children().find('input[type=checkbox]');
                          checkboxes.attr('checked', true);
                        });
                          $('.uncheck_all').click(function(){
                          var checkboxes = $(this).parent().next().children().find('input[type=checkbox]');
                          checkboxes.attr('checked', false);
                        });
                        $('.myModal select').chosen();
                        
                        $('.component_labels').click(function(){
                            var div = $("#" + $(this).data('id'));
                            if(div.data('hidden') === false){
                                $(this).next('.checkboxes_div').hide();
                                div.slideUp().data('hidden', true);
                                $(this).find('.arrow_component').removeClass('icon-arrow-up').addClass('icon-arrow-down');

                            } else {
                                div.slideDown().data('hidden', false);
                                $(this).next('.checkboxes_div').show();
                                $(this).find('.arrow_component').removeClass('icon-arrow-down').addClass('icon-arrow-up');
                            }
                        });
                      
                      //updateFeatureSelect(annotation.features, feature);
                      $('#modal_features .close').click(function(){
                        $("#modal_features").fadeOut();
                        $('#status').html('-');
                        modal = false;
                        selectedAnnotations.allograph = null;
                        selectedAnnotations.annotations = [];
                        $('.annotation_li').removeClass('selected');
                      });
                    
                  });
                   $('select[id!=id_feature]').chosen();
                   
                });
                
              }
              });
            });
          });
          });
      </script>
{% endif %}
<script type="text/javascript">
  function selectFeature(id) {
    window.opener.annotator.selectFeatureByIdAndCentre(id);
    window.opener.focus();
    return false;
  }
</script>
{% endblock %}
{% if data %}
  <h3>Hands</h3>
  {% for key, allographs in data.items %}
      <h5>{{forloop.counter}}) <a class='label' href='#{{key|anchorify}}'>{{key}}</a></h5>
  {% endfor %}
  <hr />
  {% for key, allographs in data.items %}

  <div class="scribe">
    <h2 id='{{key|anchorify}}' class='header1 header' style='padding-top: 1.5%'><b>Hand</b>: {% if image.item_part.pagination %}Page{% else %}Folio{% endif %}: 
        {{image|capfirst}} - {{ key }}</h2>
    <div class='panel'>
    {% for key, annotations in allographs.items %}

    <span><a class="label label-info" href='#{{key.id|anchorify}}_{{key|anchorify}}'>{{ key }}</a></span>

    {% endfor %}
    </div>
    {% for key, annotations in allographs.items %}

    <div>
      <h5 class='header5' style='font-size:14px;' id='{{key.id|anchorify}}_{{key|anchorify}}'>{{ key }}</h5>
      <ul>
        {% for annotation in annotations %}
        <li class='annotation_li' data-annotation = "{{ annotation.vector_id }}" data-image="{{ annotation.image_id }}">
        <p>
        <a href="/digipal/page/{{ annotation.image.id }}/?vector_id={{ annotation.vector_id }}">View</a>
        </p>
        <a href="/digipal/page/{{ annotation.image.id }}/?vector_id={{ annotation.vector_id }}" onclick="selectFeature('{{ annotation.vector_id}}');">
        {{ annotation.thumbnail }}
        </a>
        {% if can_edit %}
          <span class='label label-info'>{{forloop.counter}}</span>
        {% endif %}
        </li>
        
        {% endfor %}
       
      </ul>
    </div>
    {% endfor %}
  </div>
  {% endfor %}
</div>
<div><a id='ontop' href='#top' title='Back to Top'></a></div>
{% else %}
<div class='alert alert-warning'>No annotations available.</p>
{% endif %}
{% if can_edit %}
<div class="myModal" id='modal_features'>
  <div class="modal_header">
    <form id="frmAnnotation" method="get" name="frmAnnotation"><i class='icon icon-remove close'></i>
    <p class="myModalLabel"><span class='label-modal-value' ></span> <input style='margin-left:2%' type='button' class='btn btn-success btn-small' value='Save' id='save' /> <input type='button' class='btn btn-danger btn-small' value='Delete' id='delete' /></p>
    <p style='border-top:1px solid #efefef;padding-top:2%'></p>
  </div>
  <div class="modal-body">
    <p id='status'></p>
      {% for field in form %}
        <p>
          {{ field.label_tag }}
          {{ field }}
        </p>
      {% endfor %}
  <div id='features_container' style='margin-top:10%'></div>

  </div>
  </form>
              
{% endif %}